!function($){var e={},t=function(e,t){if(!$.isFunction(t.resolve))throw"options.resolve must be a Function";e=$(e),new n(e,t.resolve,function(n){var r=new a(n,t.resolve);new i(e,n,r)})},n=function(e,t,n){function a(e,t){return!$(t).is(":file,:button,:submit,:reset,:image,textarea,:disabled,[type=hidden]")}function i(){e.submit()}var r=[];this.getKeysInUse=function(){var e=[];return $.each(r,function(){$(this.inputElement).val()&&e.push(this.label)}),e},this.getFilters=function(){return r},this.removeFilter=function(e){$.each(r,function(){this.label===e&&($(this.inputElement).val(null),i())})},this.addFilter=function(e,t,n){"keywords"==e&&(e="Keywords"),n=Boolean(n),$.each(r,function(a,r){r.label===e&&($.isArray(t)?$(r.inputElement).val(t.join(" ")):$(r.inputElement).val(t),n||i())})};var o=this,s=e.find(":input").filter(a),l=0;s.each(function(){var a=$(this),i=$.trim(e.find("label[for="+a.attr("id")+"], label[for="+a.attr("name")+"]").text()),u={};a.is("select")&&$("option",a).each(function(){var e=$(this);e.val()&&(u[e.val()]=e.text())}),t({label:i,inputElement:a,values:u},function(e){l++,e&&r.push(e),l===s.length&&n(o)})})},a=function(e,t){function n(e){if(!$.isPlainObject(e))throw'"values" must be an object';if($.isEmptyObject(e))a.suggestionContainer.hide();else if(s===e)l&&window.clearTimeout(l),a.positionSuggestions(i);else{o.empty();var t=[];$.each(e,function(e,n){t.push([e,n])}),t.sort(function(e,t){e[1].localeCompare(t[1])}),$.each(t,function(e,t){o.append($("<li />").html(t[1]).on("click",function(e){$(this).addClass("active"),a.suggestionContainer.hide(),i.val($(this).text()).trigger("richsearch:accept")}).on("mouseover mouseout",function(e){o.children().removeClass("hover"),"mouseover"==e.type&&$(this).addClass("hover")}).data("value",t[0]))}),l&&window.clearTimeout(l),a.positionSuggestions(i)}s=e}var a={};a.suggestionContainer=$("<div />").addClass("rich-search-suggestions-container");var i=null,r=null,o=$("<ul />").appendTo(a.suggestionContainer),s=[],l;return a.positionSuggestions=function(e){a.suggestionContainer.show().offset({left:e.offset().left,top:e.parent().offset().top+e.parent().outerHeight()})},a.getKeySuggestions=function(n,a){var i=e.getFilters(),r=e.getKeysInUse(),o=0;$.each(i,function(e,s){return t(s,function(t){if(o++,i[e]=t,o===i.length){var s={};return $.each(i,function(e,t){0===t.label.toLowerCase().indexOf(n.toLowerCase())&&-1===$.inArray(t.label,r)&&(s[t.label]=t.label)}),a(s)}})})},a.getValueSuggestions=function(n,a,i){var r=e.getFilters();$.each(r,function(e,o){return o.label===a?t(o,function(e){r[a]=e;var t={};for(var a in e.values)0===e.values[a].toLowerCase().indexOf(n.toLowerCase())&&(t[a]=e.values[a]);return i(t)}):void 0})},a.updateSuggestions=function(e,t,i){"key"==e?a.getKeySuggestions(t,n):"value"==e&&a.getValueSuggestions(t,i,n)},a.updateCurrentInputElement=function(e){i=e,r||(r=e.parents(".rich-search-container"),a.suggestionContainer.appendTo(r))},a.navigate=function(e){var t=o.children("li"),n=o.children("li.active"),i,r,s;i=n?t.index(n):0,"down"==e?r=(i+1)%t.length:"up"==e&&(i--,r=0>i?t.length-1:i),s=$(t[r]),n.removeClass("active"),s.addClass("active"),a.suggestionContainer.scrollTop(a.suggestionContainer.scrollTop()+s.position().top-a.suggestionContainer.height()/2+s.height()/2)},a.isOpen=function(){return a.suggestionContainer.filter(":visible").length>0},a.isSelected=function(){return o.children("li.active").length>0},a.chooseCurrent=function(){a.suggestionContainer.hide(),i.val(o.children("li.active").text()),i.trigger("richsearch:accept")},a.hide=function(){l=window.setTimeout(function(){a.suggestionContainer.hide(),l=null},250)},a.cleanUp=function(){o.children("li").removeClass("active")},a},i=function(e,t,n){function a(){return $('<input type="text" placeholder="Search by keyword or field" autocomplete="off" size="32" />').addClass("input key").on("richsearch:accept",function(e){u(e.target.value)}).on("focus",function(e){var t=$(e.target);n.updateCurrentInputElement(t),f=t.parents("li"),t.parent("li").addClass("focus"),n.updateSuggestions("key",t.val())}).on("blur",function(e){var t=$(e.target);t.parent("li").removeClass("focus"),n.hide()}).on("keyup",function(e){y("key",e)}).on("keydown",function(e){C(e)})}function i(e){var t=a();f=$("<li />").data("state","new").addClass("active new").append(t).appendTo(g),n.updateCurrentInputElement(t),e||t.focus()}function r(e){var i=e.children("span.key"),r=i.text(),o=a().val(r);i.remove(),t.removeFilter(r),f=e,f.data("state","edit-key").append(o),k(),n.updateCurrentInputElement(o),n.updateSuggestions("key",r)}function o(e){var n=e.children("span.value");n.find("span.operator").replaceWith(" ");var a=n.text();s(e),t.addFilter(e.children("span.key").text(),p(),!1),e.removeClass("type-keyword").children("span.key").text(a).end().children("input.value").remove(),r(e)}function s(e){g.children("li").hasClass("new")&&f.remove(),f=e,f.removeClass("active").addClass("incomplete");var a=f.children("span.value"),i=a.text().trim(),r=l();a.find("span.operator").replaceWith(" "),t.removeFilter(f.children("span.key").text()),a.remove(),f.data("state","edit-value").addClass("active").removeClass("complete").append(r).children("span.close").remove(),r.val(i),k(),n.updateCurrentInputElement(r),n.updateSuggestions("value",i)}function l(){var e=$('<input type="text" autocomplete="off">').addClass("input value").on("richsearch:accept",function(e){c(e.target.value)}).on("focus",function(e){var t=$(e.target);n.updateCurrentInputElement(t),f=t.parents("li"),t.parent("li").addClass("focus"),n.updateSuggestions("value",t.val(),f.children("span.key").text())}).on("blur",function(e){var t=$(e.target);t.parent("li").removeClass("focus"),n.hide()}).on("keyup",function(e){y("value",e)}).on("keydown",function(e){var t=e.which||e.keyCode,n=e.target.value;switch(t){case 8:n||(e.preventDefault(),$(e.target).remove(),r(f))}});return f.append(e),e.focus(),e}function u(e,t){var a,i=!1;t?(f.children("input.key").remove(),a=e):(f.children("input.key").remove(),n.isSelected()?a=e:(a="Keywords",i=!0)),i?f.data("state","complete"):f.data("state","edit-value"),f.removeClass("new").prepend($("<span />").addClass("key").text(a)),i?(f.addClass("type-keyword"),c(e,!1)):d()}function c(e,n){var a=f.children("span.key").text(),i=f.hasClass("type-keyword");f.children("input.value").remove();var r=$("<span>").addClass("value").append(v());i?r.html(e.split(" ").join('<span class="operator">AND</span>')):r.text(e),f.append(r),f.data("state","complete").removeClass("active incomplete").addClass("complete").append(v().on("click",function(e){return function(n){$(n.target).off("click",n.handle),e.hasClass("type-keyword")?(e.remove(),t.addFilter(e.children("span.key").text(),p(),!1)):(t.removeFilter(e.children("span.key").text()),e.remove())}}(f)).addClass("close")),i&&(e=p()),t.addFilter(f.children("span.key").text(),e,n),d()}function p(){return $.map(g.find(".type-keyword .value"),function(e){return $(e).clone().find("span").replaceWith(" ").end().text()})}function d(e){if(e=e||!1)return s(e),!1;n.cleanUp();var t=g.find(".incomplete:eq(0)");switch(f.data("state")){case"edit-value":l();break;case"complete":t.length>0?t.children("input").focus():i(!1)}}var h=$("<div>"),f=null,v=function(){return $("<span><i>&times;</i></span>")},g=$("<ul />").addClass("rich-search-terms").appendTo(h).on("click","li",function(e){$(this).hasClass("complete")?$(this).hasClass("type-keyword")?o($(this)):s($(this)):$(this).children("input").length>0&&w($(this))});h.addClass("rich-search-container").insertAfter(e).on("click",function(e){($(e.target).is("div")||$(e.target).is("ul"))&&k()}),e.on("ajaxComplete:richSearch",function(){setTimeout(function(){h.trigger("click")},10)});var m=!0;i(m),$.each(t.getFilters(),function(e,t){var n=$(t.inputElement);return(n.val()||""!==n.val())&&(u(t.label,!0),t.inputElement.is("select")?c(t.inputElement.find('option[value="'+n.val()+'"]').text(),!0):c(n.val(),!0)),!0});var y=function(e,t){var a=t.which||t.keyCode,i=String.fromCharCode(a),r=t.target.value.trim();switch(a){case 13:case 9:if(t.preventDefault(),13===a&&n.isOpen()&&n.isSelected())n.chooseCurrent();else{if(!Boolean(r))return!1;"key"==e?u(r):c(r)}break;case 38:case 40:t.preventDefault(),38===a&&n.navigate("up"),40===a&&n.navigate("down");break;case 37:case 39:break;default:activeFilterItemValue="value"==e?f.children("span.key").text():null,n.updateSuggestions(e,r,activeFilterItemValue)}},C=function(e){var t=$(e.target).parents("li"),n=e.which||e.keyCode;switch(n){case 8:var a=t.children("input.key");a.length>0&&!a.val()&&g.children("li").length>1&&(e.preventDefault(),nextFilterItem=Boolean(t.prev().length)?t.prev():t.next(),nextFilterItem.hasClass("type-keyword")?o(nextFilterItem):s(nextFilterItem),t.remove())}},k=function(){w(f)},w=function(e){e.children("input").focus().setCursorPosition(9999)}};$.fn.richSearch=function(n){return n=$.extend({},e,n),this.each(function(){if(!$(this).is("form"))return!1;var e=$.data(this,"RichSearch");e||(e=new t(this,n),$.data(this,"RichSearch",e))})},$.fn.setCursorPosition=function(e){return this.each(function(t,n){if(n.setSelectionRange)n.setSelectionRange(e,e);else if(n.createTextRange){var a=n.createTextRange();a.collapse(!0),a.moveEnd("character",e),a.moveStart("character",e),a.select()}}),this},$.arraysEqual=function(e,t){if(e===t)return!0;if(null==e||null==t)return!1;if(e.length!=t.length)return!1;for(var n=0;n<e.length;++n)if(e[n]!==t[n])return!1;return!0},Object.keys||(Object.keys=function(){"use strict";var e=Object.prototype.hasOwnProperty,t=!{toString:null}.propertyIsEnumerable("toString"),n=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],a=n.length;return function(i){if("object"!=typeof i&&("function"!=typeof i||null===i))throw new TypeError("Object.keys called on non-object");var r=[],o,s;for(o in i)e.call(i,o)&&r.push(o);if(t)for(s=0;a>s;s++)e.call(i,n[s])&&r.push(n[s]);return r}}())}(jQuery);