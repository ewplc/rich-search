!function($){var e={},t=function(e,t){if(!$.isFunction(t.resolve))throw"options.resolve must be a Function";e=$(e),new n(e,t.resolve,function(n){var r=new i(n,t.resolve);new a(e,n,r)})},n=function(e,t,n){function i(e,t){return!$(t).is(":file,:button,:submit,:reset,:image,textarea,:disabled,[type=hidden]")}function a(){e.submit()}var r=[];this.getKeysInUse=function(){var e=[];return $.each(r,function(){$(this.inputElement).val()&&e.push(this.label)}),e},this.getFilters=function(){return r},this.removeFilter=function(e){$.each(r,function(){this.label===e&&($(this.inputElement).val(null),a())})},this.addFilter=function(e,t,n){"keywords"==e&&(e="Keywords"),n=Boolean(n),$.each(r,function(i,r){r.label===e&&($input=$(r.inputElement),$.isArray(t)&&(t=t.join(" ")),$input.is("select")?$input.find("option").filter(function(){return $(this).val().toLowerCase()==t.toLowerCase()}).prop("selected",!0):$input.filter(function(){return $(this).val().toLowerCase()==t.toLowerCase()}).val(t),n||a())})};var o=this,s=e.find(":input").filter(i),l=0;s.each(function(){var i=$(this),a=e.find('label[for="'+i.attr("id")+'"], label[for="'+i.attr("name")+'"]').text().trim(),u={};i.is("select")&&$("option",i).each(function(){var e=$(this);e.val()&&(u[e.val()]=e.text())}),t({label:a,inputElement:i,values:u},function(e){l++,e&&r.push(e),l===s.length&&n(o)})})},i=function(e,t){function n(e){if(!$.isPlainObject(e))throw'"values" must be an object';if($.isEmptyObject(e))i.suggestionContainer.hide();else if(s===e)l&&window.clearTimeout(l),i.positionSuggestions(a);else{o.empty();var t=[];$.each(e,function(e,n){t.push([e,n])}),t.sort(function(e,t){e[1].localeCompare(t[1])}),$.each(t,function(e,t){o.append($("<li />").html(t[1]).on("click",function(e){$(this).addClass("active"),i.suggestionContainer.hide(),a.val($(this).text()).trigger("richsearch:accept")}).on("mouseover mouseout",function(e){o.children().removeClass("hover"),"mouseover"==e.type&&$(this).addClass("hover")}).data("value",t[0]))}),l&&window.clearTimeout(l),i.positionSuggestions(a)}s=e}var i={};i.suggestionContainer=$("<div />").addClass("rich-search-suggestions-container");var a=null,r=null,o=$("<ul />").appendTo(i.suggestionContainer),s=[],l;return i.positionSuggestions=function(e){i.suggestionContainer.show().offset({left:e.offset().left,top:e.parent().offset().top+e.parent().outerHeight()})},i.getKeySuggestions=function(n,i){var a=e.getFilters(),r=e.getKeysInUse(),o=0;$.each(a,function(e,s){return t(s,function(t){if(o++,a[e]=t,o===a.length){var s={};return $.each(a,function(e,t){0===t.label.toLowerCase().indexOf(n.toLowerCase())&&-1===$.inArray(t.label,r)&&(s[t.label]=t.label)}),i(s)}})})},i.getValueSuggestions=function(n,i,a){var r=e.getFilters();$.each(r,function(e,o){return o.label===i?t(o,function(e){r[i]=e;var t={};for(var i in e.values)e.values[i]&&0===e.values[i].toLowerCase().indexOf(n.toLowerCase())&&(t[i]=e.values[i]);return a(t)}):void 0})},i.updateSuggestions=function(e,t,a){"key"==e?i.getKeySuggestions(t,n):"value"==e&&i.getValueSuggestions(t,a,n)},i.updateCurrentInputElement=function(e){a=e,r||(r=e.parents(".rich-search-container"),i.suggestionContainer.appendTo(r))},i.navigate=function(e){var t=o.children("li"),n=o.children("li.active"),a,r,s;a=n?t.index(n):0,"down"==e?r=(a+1)%t.length:"up"==e&&(a--,r=0>a?t.length-1:a),s=$(t[r]),n.removeClass("active"),s.addClass("active"),i.suggestionContainer.scrollTop(i.suggestionContainer.scrollTop()+s.position().top-i.suggestionContainer.height()/2+s.height()/2)},i.isOpen=function(){return i.suggestionContainer.filter(":visible").length>0},i.isSelected=function(){return o.children("li.active").length>0},i.chooseCurrent=function(){i.suggestionContainer.hide(),a.val(o.children("li.active").text()),a.trigger("richsearch:accept")},i.hide=function(){l=window.setTimeout(function(){i.suggestionContainer.hide(),l=null},250)},i.cleanUp=function(){o.children("li").removeClass("active")},i},a=function(e,t,n){function i(){return $('<input type="text" placeholder="Search by keyword or field" autocomplete="off" size="32" />').addClass("input key").on("richsearch:accept",function(e){u(e.target.value)}).on("focus",function(e){var t=$(e.target);n.updateCurrentInputElement(t),f=t.parents("li"),t.parent("li").addClass("focus"),n.updateSuggestions("key",t.val())}).on("blur",function(e){var t=$(e.target);t.parent("li").removeClass("focus"),n.hide()}).on("keyup",function(e){y("key",e)}).on("keydown",function(e){C(e)})}function a(e){var t=i();f=$("<li />").data("state","new").addClass("active new").append(t).appendTo(g),n.updateCurrentInputElement(t),e||t.focus()}function r(e){var a=e.children("span.key"),r=a.text(),o=i().val(r);a.remove(),t.removeFilter(r),f=e,f.data("state","edit-key").append(o),w(),n.updateCurrentInputElement(o),n.updateSuggestions("key",r)}function o(e){var n=e.children("span.value");n.find("span.operator").replaceWith(" ");var i=n.text();s(e),t.addFilter(e.children("span.key").text(),p(),!1),e.removeClass("type-keyword").children("span.key").text(i).end().children("input.value").remove(),r(e)}function s(e){g.children("li").hasClass("new")&&f.remove(),f=e,f.removeClass("active").addClass("incomplete");var i=f.children("span.value"),a=i.text().trim(),r=l();i.find("span.operator").replaceWith(" "),t.removeFilter(f.children("span.key").text()),i.remove(),f.data("state","edit-value").addClass("active").removeClass("complete").append(r).children("span.close").remove(),r.val(a),w(),n.updateCurrentInputElement(r),n.updateSuggestions("value",a)}function l(){var e=$('<input type="text" autocomplete="off">').addClass("input value").on("richsearch:accept",function(e){c(e.target.value)}).on("focus",function(e){var t=$(e.target);n.updateCurrentInputElement(t),f=t.parents("li"),t.parent("li").addClass("focus"),n.updateSuggestions("value",t.val(),f.children("span.key").text())}).on("blur",function(e){var t=$(e.target);t.parent("li").removeClass("focus"),n.hide()}).on("keyup",function(e){y("value",e)}).on("keydown",function(e){var t=e.which||e.keyCode,n=e.target.value;switch(t){case 8:n||(e.preventDefault(),$(e.target).remove(),r(f))}});return f.append(e),e.focus(),e}function u(e,t){var i,a=!1;t?(f.children("input.key").remove(),i=e):(f.children("input.key").remove(),n.isSelected()?i=e:(i="Keywords",a=!0)),a?f.data("state","complete"):f.data("state","edit-value"),f.removeClass("new").prepend($("<span />").addClass("key").text(i)),a?(f.addClass("type-keyword"),c(e,!1)):d()}function c(e,n){var i=f.children("span.key").text(),a=f.hasClass("type-keyword");f.children("input.value").remove();var r=$("<span>").addClass("value").append(v());a?r.html(e.split(" ").join('<span class="operator">AND</span>')):r.text(e),f.append(r),f.data("state","complete").removeClass("active incomplete").addClass("complete").append(v().on("click",function(e){return function(n){$(n.target).off("click",n.handle),e.hasClass("type-keyword")?(e.remove(),t.addFilter(e.children("span.key").text(),p(),!1)):(t.removeFilter(e.children("span.key").text()),e.remove())}}(f)).addClass("close")),a&&(e=p()),t.addFilter(f.children("span.key").text(),e,n),d()}function p(){return $.map(g.find(".type-keyword .value"),function(e){return $(e).clone().find("span").replaceWith(" ").end().text()})}function d(e){if(e=e||!1)return s(e),!1;n.cleanUp();var t=g.find(".incomplete:eq(0)");switch(f.data("state")){case"edit-value":l();break;case"complete":t.length>0?t.children("input").focus():a(!1)}}var h=$("<div>"),f=null,v=function(){return $("<span><i>&times;</i></span>")},g=$("<ul />").addClass("rich-search-terms").appendTo(h).on("click","li",function(e){$(this).hasClass("complete")?$(this).hasClass("type-keyword")?o($(this)):s($(this)):$(this).children("input").length>0&&k($(this))});h.addClass("rich-search-container").insertAfter(e).on("click",function(e){($(e.target).is("div")||$(e.target).is("ul"))&&w()}),e.on("ajaxComplete:richSearch",function(){setTimeout(function(){h.trigger("click")},10)});var m=!0;a(m),$.each(t.getFilters(),function(e,t){var n=$(t.inputElement);return(n.val()||""!==n.val())&&(u(t.label,!0),t.inputElement.is("select")?c(t.inputElement.find('option[value="'+n.val()+'"]').text(),!0):c(n.val(),!0)),!0});var y=function(e,t){var i=t.which||t.keyCode,a=String.fromCharCode(i),r=t.target.value.trim();switch(i){case 13:case 9:if(t.preventDefault(),13===i&&n.isOpen()&&n.isSelected())n.chooseCurrent();else{if(!Boolean(r))return!1;"key"==e?u(r):c(r)}break;case 38:case 40:t.preventDefault(),38===i&&n.navigate("up"),40===i&&n.navigate("down");break;case 37:case 39:break;default:activeFilterItemValue="value"==e?f.children("span.key").text():null,n.updateSuggestions(e,r,activeFilterItemValue)}},C=function(e){var t=$(e.target).parents("li"),n=e.which||e.keyCode;switch(n){case 8:var i=t.children("input.key");i.length>0&&!i.val()&&g.children("li").length>1&&(e.preventDefault(),nextFilterItem=Boolean(t.prev().length)?t.prev():t.next(),nextFilterItem.hasClass("type-keyword")?o(nextFilterItem):s(nextFilterItem),t.remove())}},w=function(){k(f)},k=function(e){e.children("input").focus().setCursorPosition(9999)}};$.fn.richSearch=function(n){return n=$.extend({},e,n),this.each(function(){if(!$(this).is("form"))return!1;var e=$.data(this,"RichSearch");e||(e=new t(this,n),$.data(this,"RichSearch",e))})},$.fn.setCursorPosition=function(e){return this.each(function(t,n){if(n.setSelectionRange)n.setSelectionRange(e,e);else if(n.createTextRange){var i=n.createTextRange();i.collapse(!0),i.moveEnd("character",e),i.moveStart("character",e),i.select()}}),this},$.arraysEqual=function(e,t){if(e===t)return!0;if(null==e||null==t)return!1;if(e.length!=t.length)return!1;for(var n=0;n<e.length;++n)if(e[n]!==t[n])return!1;return!0},Object.keys||(Object.keys=function(){"use strict";var e=Object.prototype.hasOwnProperty,t=!{toString:null}.propertyIsEnumerable("toString"),n=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],i=n.length;return function(a){if("object"!=typeof a&&("function"!=typeof a||null===a))throw new TypeError("Object.keys called on non-object");var r=[],o,s;for(o in a)e.call(a,o)&&r.push(o);if(t)for(s=0;i>s;s++)e.call(a,n[s])&&r.push(n[s]);return r}}())}(jQuery);